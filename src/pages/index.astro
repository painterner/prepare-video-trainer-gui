---
import "../styles/global.css";
import TrimApp from "../components/TrimApp";
const defaultMetaPath = import.meta.env.DATASET_META_PATH ?? "/home/ka/all-ref/MY_LTX-2/data/dataset_meta.jsonl";
---

<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>LTX-2 Trim GUI</title>
	</head>
	<body class="m-0 bg-[#0b0f17] text-[#e7ecf3]">
		<header class="px-6 py-5 bg-[#141a26] border-b border-[#2a3244] flex items-center gap-4">
			<h1 class="text-xl font-semibold m-0 whitespace-nowrap">LTX-2 参考音频 / 尾段视频裁剪</h1>
			<input
				type="text"
				id="download-url"
				placeholder="输入视频 URL"
				class="flex-1 max-w-md px-2.5 py-1.5 rounded-lg border border-[#2a3244] bg-[#1b2232] text-[#e7ecf3] text-sm"
			/>
			<input
				type="text"
				id="download-start"
				placeholder="起始 (如 1:00)"
				class="w-24 px-2.5 py-1.5 rounded-lg border border-[#2a3244] bg-[#1b2232] text-[#e7ecf3] text-sm"
			/>
			<input
				type="text"
				id="download-end"
				placeholder="结束 (如 5:00)"
				class="w-24 px-2.5 py-1.5 rounded-lg border border-[#2a3244] bg-[#1b2232] text-[#e7ecf3] text-sm"
			/>
			<button
				id="download-btn"
				class="px-3 py-1.5 rounded-lg bg-[#4f8cff] text-white text-sm cursor-pointer"
			>
				下载
			</button>
			<span id="download-status" class="text-[#a9b2c3] text-xs"></span>
		</header>
		<script>
			const downloadBtn = document.getElementById('download-btn');
			const downloadUrl = document.getElementById('download-url') as HTMLInputElement;
			const downloadStart = document.getElementById('download-start') as HTMLInputElement;
			const downloadEnd = document.getElementById('download-end') as HTMLInputElement;
			const downloadStatus = document.getElementById('download-status');

			downloadBtn?.addEventListener('click', async () => {
				const url = downloadUrl?.value?.trim();
				if (!url) {
					if (downloadStatus) downloadStatus.textContent = '请输入 URL';
					return;
				}
				if (downloadStatus) downloadStatus.textContent = '下载中...';
				try {
					const payload: Record<string, string> = { url };
					const startTime = downloadStart?.value?.trim();
					const endTime = downloadEnd?.value?.trim();
					if (startTime) payload.startTime = startTime;
					if (endTime) payload.endTime = endTime;
					
					const response = await fetch('/api/download.json', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload),
					});
					const data = await response.json();
					if (!response.ok) {
						throw new Error(data.error || '下载失败');
					}
					if (downloadStatus) downloadStatus.textContent = `已下载: ${data.filename}`;
					downloadUrl.value = '';
					downloadStart.value = '';
					downloadEnd.value = '';
				} catch (error: any) {
					if (downloadStatus) downloadStatus.textContent = error.message || '下载失败';
				}
			});
		</script>
		<main>
			<TrimApp client:load defaultMetaPath={defaultMetaPath} />
		</main>
	</body>
</html>
